<?html

// RÃ©cupÃ¨re le commentaire en attente
$stmt = $conn->prepare("SELECT email, content FROM pending_comments WHERE token = ?");
$stmt->bind_param("s", $token);
$stmt->execute();
$stmt->store_result();

if ($stmt->num_rows === 0) {
    die('Token invalide ou commentaire dÃ©jÃ  validÃ©.');
}

$stmt->bind_result($email, $content);
$stmt->fetch();
$stmt->close();

// Transfert vers la table finale
$stmt = $conn->prepare("INSERT INTO comments (email, content, created_at) VALUES (?, ?, NOW())");
$stmt->bind_param("ss", $email, $content);
$stmt->execute();
$stmt->close();

// Supprime de pending
$stmt = $conn->prepare("DELETE FROM pending_comments WHERE token = ?");
$stmt->bind_param("s", $token);
$stmt->execute();
$stmt->close();

// Envoi d'un email de remerciement
$mail = new PHPMailer(true);
try {
    $mail->isSMTP();
    $mail->Host       = 'hockeyfan88@hotmail.fr';     // <-- Ã€ personnaliser
    $mail->SMTPAuth   = true;
    $mail->Username   = 'Admin';       // <-- Ã€ personnaliser
    $mail->Password   = 'patate1234';         // <-- Ã€ personnaliser
    $mail->SMTPSecure = 'tls';
    $mail->Port       = 587;

    $mail->setFrom('noreply@projectanima.com', 'Project Anima');
    $mail->addAddress($email);

    $mail->isHTML(true);
    $mail->Subject = 'Merci pour votre commentaire !';
    $mail->Body    = "<p>Bonjour,</p>
                      <p>Merci dâ€™avoir partagÃ© votre avis sur <strong>Project Anima</strong> !</p>
                      <p>Votre soutien nous aide Ã  rendre ce projet encore plus terrifiant et immersif.</p>
                      <p>Restez Ã  lâ€™affÃ»t... des surprises pourraient bientÃ´t tomber dans votre boÃ®te mail ğŸ˜ˆ</p>
                      <p>- Lâ€™Ã©quipe Project Anima</p>";
    $mail->send();
} catch (Exception $e) {
    // On n'affiche pas l'erreur pour Ã©viter d'inquiÃ©ter l'utilisateur
}

echo '<script>alert("Merci ! Votre commentaire a Ã©tÃ© validÃ©."); window.location.href="../comments.html";</script>';
?>
