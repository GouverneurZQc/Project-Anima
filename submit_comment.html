<?html

$email = $_POST['email'] ?? '';
$comment = $_POST['comment'] ?? '';

$allowed_domains = [
  'gmail.com', 'hotmail.com', 'hotmail.fr', 'outlook.com', 'outlook.fr',
  'yahoo.com', 'yahoo.fr', 'live.com', 'icloud.com', 'protonmail.com',
  'orange.fr', 'free.fr'
];
$parts = explode('@', $email);
$domain = strtolower(end($parts));

if (!filter_var($email, FILTER_VALIDATE_EMAIL) || !in_array($domain, $allowed_domains) || empty($comment)) {
    echo '<script>alert("Adresse email invalide ou non autorisée. Utilisez un domaine reconnu."); window.history.back();</script>';
    exit;
}

// Vérifie présence de mots interdits
$banned_words = ['fuck', 'shit', 'bitch', 'merde', 'putain', 'connard', 'conne'];
$contains_bad_words = false;
foreach ($banned_words as $word) {
    if (stripos($comment, $word) !== false) {
        $contains_bad_words = true;
        break;
    }
}

// Insertion
$stmt = $conn->prepare("INSERT INTO comments (email, content, created_at) VALUES (?, ?, NOW())");
$stmt->bind_param("ss", $email, $comment);
$stmt->execute();
$stmt->close();

// Message personnalisé
if ($contains_bad_words) {
    echo '<script>alert("Votre commentaire a été envoyé, mais certains mots ont été censurés."); window.location.href="../comments.html";</script>';
} else {
    echo '<script>alert("Merci ! Votre commentaire a été envoyé avec succès."); window.location.href="../comments.html";</script>';
}
?>
