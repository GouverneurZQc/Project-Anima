<?html

// Vérifier si l'utilisateur est banni
$stmt_ip = $conn->prepare("SELECT pseudo FROM patients WHERE ip_address = ?");
$stmt_ip->bind_param("s", $ip);
$stmt_ip->execute();
$stmt_ip->store_result();
$stmt_ip->bind_result($found_pseudo);
$stmt_ip->fetch();
$stmt_ip->close();

// Soit le joueur existe déjà, soit on le crée
$stmt = $conn->prepare("SELECT pseudo FROM patients WHERE ip_address = ?");
$stmt->bind_param("s", $ip);
$stmt->execute();
$stmt->store_result();

if ($stmt->num_rows === 0) {
  $result = $conn->query("SELECT COUNT(*) AS total FROM patients");
  $count = $result->fetch_assoc()['total'] + 1;
  $pseudo = "Patient_" . str_pad($count, 2, "0", STR_PAD_LEFT);
  $insert = $conn->prepare("INSERT INTO patients (ip_address, pseudo) VALUES (?, ?)");
  $insert->bind_param("ss", $ip, $pseudo);
  $insert->execute();
  $_SESSION['pseudo'] = $pseudo;
  $insert->close();
} else {
  $stmt->bind_result($pseudo);
  $stmt->fetch();
  $_SESSION['pseudo'] = $pseudo;
}
$stmt->close();
$conn->close();
header("Location: fenetrechat.html");
exit;
?>
