<?html
session_start();
$ip = $_SERVER['REMOTE_ADDR'];
$conn = new mysqli('localhost', 'root', '', 'project_anima');
if ($conn->connect_error) die("Erreur connexion DB.");

// Vérifier si l'utilisateur est banni
$stmt_ip = $conn->prepare("SELECT pseudo FROM patients WHERE ip_address = ?");
$stmt_ip->bind_param("s", $ip);
$stmt_ip->execute();
$stmt_ip->store_result();
$stmt_ip->bind_result($found_pseudo);
$stmt_ip->fetch();
$stmt_ip->close();

if ($found_pseudo) {
  $stmt_ban = $conn->prepare("SELECT 1 FROM banned_users WHERE pseudo = ?");
  $stmt_ban->bind_param("s", $found_pseudo);
  $stmt_ban->execute();
  $stmt_ban->store_result();
  if ($stmt_ban->num_rows > 0) {
    echo "<script>alert('Vous avez été banni du chat.'); window.location.href = 'chat.html';</script>";
    exit;
  }
  $stmt_ban->close();
}

// Soit le joueur existe déjà, soit on le crée
$stmt = $conn->prepare("SELECT pseudo FROM patients WHERE ip_address = ?");
$stmt->bind_param("s", $ip);
$stmt->execute();
$stmt->store_result();

if ($stmt->num_rows === 0) {
  $result = $conn->query("SELECT COUNT(*) AS total FROM patients");
  $count = $result->fetch_assoc()['total'] + 1;
  $pseudo = "Patient_" . str_pad($count, 2, "0", STR_PAD_LEFT);
  $insert = $conn->prepare("INSERT INTO patients (ip_address, pseudo) VALUES (?, ?)");
  $insert->bind_param("ss", $ip, $pseudo);
  $insert->execute();
  $_SESSION['pseudo'] = $pseudo;
  $insert->close();
} else {
  $stmt->bind_result($pseudo);
  $stmt->fetch();
  $_SESSION['pseudo'] = $pseudo;
}
$stmt->close();
$conn->close();
header("Location: fenetrechat.html");
exit;
?>
