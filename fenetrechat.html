<?html
session_start();
$is_admin = isset($_SESSION['admin']) && $_SESSION['admin'] === true;
$pseudo = $_SESSION['pseudo'] ?? ($is_admin ? 'M√©decin en Chef' : null);

if (!$pseudo) {
  header("Location: chat.html");
  exit;
}
?>
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Chat - Project Anima</title>
  <link href="https://fonts.googleapis.com/css2?family=Special+Elite&display=swap" rel="stylesheet">
  <style>
    body {
      background-color: #000;
      color: #eee;
      font-family: 'Special Elite', cursive;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    header img {
      width: 100%;
      max-height: 120px;
      object-fit: contain;
    }
    nav {
      background-color: #111;
      padding: 10px;
      text-align: center;
      width: 100%;
    }
    nav a {
  font-weight: bold;
      color: crimson;
      margin: 0 10px;
      text-decoration: none;
    }
    .chat-container {
      max-width: 800px;
      width: 95%;
      margin-top: 20px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      background: #111;
      color: #aaa;
      font-size: 14px;
    }
    #chat-box {
      height: 400px;
      overflow-y: auto;
      padding: 15px;
      background: #111;
      border: 1px solid #333;
    }
    .message {
      font-size: 13px;
      margin-bottom: 12px;
      border-bottom: 1px dashed #444;
      padding-bottom: 6px;
    }
    footer {
      background: #111;
      display: flex;
      padding: 10px;
      margin-top: 10px;
      width: 100%;
    }
    input[type="text"] {
      flex: 1;
      padding: 10px;
      background-color: #000;
      color: #eee;
      border: 1px solid crimson;
    }
    button {
      padding: 10px 20px;
      background-color: crimson;
      color: white;
      border: none;
      margin-left: 10px;
      cursor: pointer;
    }
    #muteToggle {
      margin: 10px auto;
    }
  </style>
</head>
<body>
  <header>
    <img src="img/banner.jpg" alt="Banni√®re du jeu">
  </header>
  <nav>
    <a href="index.html">Accueil</a>
    <a href="updates.html">Mise √† jour</a>
    <a href="info.html">Information</a>
    <a href="images.html">Images</a>
    <a href="video.html">Vid√©os</a>
    <a href="download.html">T√©l√©chargement</a>
    <a href="contact.html">Contact</a>
    <a href="comments.html">Commentaires</a>
    <a href="chat.html">Chat</a>
  </nav>

  <div class="chat-container">
    <div class="top-bar">
      <div>Connect√© en tant que : <strong><?= htmlspecialchars($pseudo) ?></strong></div>
      <div id="online-count">Utilisateurs en ligne : ...</div>
      <form method="POST" action="logout.html">
        <button type="submit">D√©connexion</button>
      </form>
    </div>
    <div id="chat-box"></div>
    <footer>
      <input type="text" id="message-input" placeholder="Votre message..." />
      <button id="send-btn">Envoyer</button>
    </footer>
    <audio id="notifSound" src="https://notificationsounds.com/storage/sounds/file-sounds-1153-pristine.mp3" preload="auto"></audio>
    <button id="muteToggle">üîä Son activ√©</button>
  </div>

  <script>
    let soundEnabled = true;
    document.getElementById('muteToggle').onclick = function() {
      soundEnabled = !soundEnabled;
      this.innerText = soundEnabled ? "üîä Son activ√©" : "üîá Son d√©sactiv√©";
    };

    function loadMessages() {
      fetch('load_messages.php')
        .then(res => res.text())
        .then(data => {
          const box = document.getElementById('chat-box');
          const oldScroll = box.scrollTop;
          box.innerHTML = data;
          if (soundEnabled) document.getElementById('notifSound').play();
        });

      fetch('user_count.php')
        .then(res => res.text())
        .then(count => {
          document.getElementById('online-count').innerText = 'Utilisateurs en ligne : ' + count;
        });
    }

    function sendMessage() {
      const input = document.getElementById('message-input');
      const message = input.value.trim();
      if (!message) return;

      fetch('send_message.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'message=' + encodeURIComponent(message)
      })
      .then(res => res.text())
      .then(response => {
        if (response === "muted") {
          alert("‚ö†Ô∏è Vous √™tes muet, vos messages ne seront pas envoy√©s.");
        } else {
          input.value = '';
          loadMessages();
        }
      });
    }

    document.getElementById('send-btn').onclick = sendMessage;
    document.getElementById('message-input').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') sendMessage();
    });

    setInterval(loadMessages, 3000);
    window.onload = loadMessages;
  </script>
</body>
</html>
