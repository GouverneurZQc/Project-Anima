<?html
session_start();
$conn = new mysqli("localhost", "root", "", "project_anima");

if ($conn->connect_error) {
  http_response_code(500);
  echo "Erreur DB";
  exit;
}

$ip = $_SERVER['REMOTE_ADDR'];
$date = date('Y-m-d');

// Vérifie si cette IP a déjà téléchargé aujourd'hui
$check = $conn->prepare("SELECT * FROM downloads WHERE ip_address = ? AND download_date = ?");
$check->bind_param("ss", $ip, $date);
$check->execute();
$result = $check->get_result();

if ($result->num_rows === 0) {
  $insert = $conn->prepare("INSERT INTO downloads (ip_address, download_date) VALUES (?, ?)");
  $insert->bind_param("ss", $ip, $date);
  $insert->execute();
  $insert->close();
}
$check->close();

// Compte le nombre total de téléchargements
$total = $conn->query("SELECT COUNT(*) AS total FROM downloads")->fetch_assoc()['total'];
echo $total;
$conn->close();
?>
